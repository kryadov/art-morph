(()=>{const e=e=>document.querySelector(e),t=document.getElementById("glcanvas"),n=document.getElementById("overlay2d"),a=n?n.getContext("2d"):null,r=document.getElementById("gl-fallback"),i={controls:e("#controls"),fractal:e("#fractal"),palette:e("#palette"),iterations:e("#iterations"),zoom:e("#zoom"),rotation:e("#rotation"),speed:e("#speed"),playPause:e("#playPause"),reset:e("#reset"),recenter:e("#recenter"),musicFile:e("#musicFile"),musicPlay:e("#musicPlay"),musicStop:e("#musicStop"),iterationsValue:e("#iterationsValue"),zoomValue:e("#zoomValue"),rotationValue:e("#rotationValue"),speedValue:e("#speedValue")},o={fractalType:0,palette:0,maxIter:200,scale:1,rotationDeg:0,speed:1,playing:!0,center:{x:-.2,y:0}};let c=null,l=null,s=null,u={},p={},f=Math.min(window.devicePixelRatio||1,2),m=performance.now(),h=0,d=!0,x=!0,v={x:0,y:0,ready:!1},y=new Audio;y.loop=!0;let g=null;window.addEventListener("beforeunload",()=>{try{y.pause()}catch(e){}if(g){try{URL.revokeObjectURL(g)}catch(e){}g=null}});const M="ui.controlsHidden";function _(e){const t=i.controls;if(t){t.classList.toggle("hidden",!!e),t.setAttribute("aria-hidden",e?"true":"false");try{localStorage.setItem(M,e?"1":"0")}catch(e){}}}function L(e,t){const n=c.createShader(e);if(c.shaderSource(n,t),c.compileShader(n),!c.getShaderParameter(n,c.COMPILE_STATUS)){const e=c.getShaderInfoLog(n);throw c.deleteShader(n),new Error("Shader compile error: "+e)}return n}function b(){l=function(e,t){const n=L(c.VERTEX_SHADER,e),a=L(c.FRAGMENT_SHADER,t),r=c.createProgram();if(c.attachShader(r,n),c.attachShader(r,a),c.bindAttribLocation(r,0,"a_position"),c.linkProgram(r),c.deleteShader(n),c.deleteShader(a),!c.getProgramParameter(r,c.LINK_STATUS)){const e=c.getProgramInfoLog(r);throw c.deleteProgram(r),new Error("Program link error: "+e)}return r}("\nattribute vec2 a_position;\nvoid main() {\n  gl_Position = vec4(a_position, 0.0, 1.0);\n}","\nprecision highp float;\n\nuniform vec2 u_resolution;  // canvas size in pixels\nuniform vec2 u_center;      // complex plane center\nuniform float u_span;       // base span scaled by zoom (width of plane)\nuniform float u_rotation;   // radians\nuniform float u_time;       // seconds\nuniform int u_maxIter;\nuniform int u_palette;      // 0=Khokhloma,1=Gzhel,2=Rainbow\nuniform int u_fractalType;  // 0=Julia,1=Tri,2=Carpet\n\n// Utility: rotate 2D vector\nmat2 rot(float a) {\n  float c = cos(a), s = sin(a);\n  return mat2(c, -s, s, c);\n}\n\n// Convert HSV to RGB\nvec3 hsv2rgb(vec3 c) {\n  vec3 p = abs(fract(c.xxx + vec3(0., 2./6., 4./6.)) * 6. - 3.);\n  vec3 rgb = clamp(p - 1., 0., 1.);\n  return c.z * mix(vec3(1.), rgb, c.y);\n}\n\n// Khokhloma-inspired palette: deep reds to gold with black background\nvec3 paletteKhokhloma(float t) {\n  // Clamp and ease\n  t = clamp(t, 0., 1.);\n  // Color stops\n  vec3 c0 = vec3(0.02, 0.0, 0.0);     // near black with hint of red\n  vec3 c1 = vec3(0.35, 0.0, 0.02);    // deep crimson\n  vec3 c2 = vec3(0.8, 0.15, 0.0);     // red-orange\n  vec3 c3 = vec3(1.0, 0.65, 0.0);     // gold\n  vec3 c4 = vec3(1.0, 0.9, 0.4);      // pale gold/white\n  if (t < 0.25) return mix(c0, c1, smoothstep(0., 0.25, t));\n  if (t < 0.5)  return mix(c1, c2, smoothstep(0.25, 0.5, t));\n  if (t < 0.8)  return mix(c2, c3, smoothstep(0.5, 0.8, t));\n  return mix(c3, c4, smoothstep(0.8, 1.0, t));\n}\n\n// Gzhel-inspired palette: deep blue to white porcelain\nvec3 paletteGzhel(float t) {\n  t = clamp(t, 0., 1.);\n  vec3 c0 = vec3(0.02, 0.05, 0.12);   // near black/blue\n  vec3 c1 = vec3(0.05, 0.25, 0.65);   // cobalt\n  vec3 c2 = vec3(0.35, 0.55, 0.95);   // light blue\n  vec3 c3 = vec3(0.92, 0.96, 1.0);    // porcelain white\n  if (t < 0.4) return mix(c0, c1, smoothstep(0., 0.4, t));\n  if (t < 0.75) return mix(c1, c2, smoothstep(0.4, 0.75, t));\n  return mix(c2, c3, smoothstep(0.75, 1.0, t));\n}\n\nvec3 paletteRainbow(float t) {\n  return hsv2rgb(vec3(fract(t + 0.0), 0.85, 1.0));\n}\n\nvec3 getPalette(float t, int which) {\n  if (which == 0) return paletteKhokhloma(t);\n  if (which == 1) return paletteGzhel(t);\n  return paletteRainbow(t);\n}\n\n// Compute color for Julia set at point z0\nvec3 colorJulia(vec2 z0) {\n  vec2 z = z0;\n  // Animate c over time to morph shapes\n  float t = u_time * 0.25; // slow down a bit\n  vec2 c = vec2(0.285 + 0.25*cos(t*1.7), 0.01 + 0.25*sin(t*1.2));\n\n  int maxIter = u_maxIter;\n  float i = 0.0;\n  float trap = 1e9;\n  for (int ii = 0; ii < 2000; ii++) {\n    i = float(ii);\n    if (ii >= maxIter) break;\n    vec2 z2 = vec2(z.x*z.x - z.y*z.y, 2.0*z.x*z.y) + c;\n    z = z2;\n    float r2 = dot(z, z);\n    trap = min(trap, abs(z.x) + abs(z.y));\n    if (r2 > 256.0) break;\n  }\n\n  float colorT;\n  if (int(i) >= maxIter) {\n    colorT = 0.0;\n  } else {\n    float r = length(z);\n    float nu = i - log2(log2(max(r, 1.001))) + 4.0;\n    colorT = nu / float(maxIter);\n  }\n  colorT = clamp(colorT + 0.15 * exp(-3.0*trap), 0.0, 1.0);\n  return getPalette(colorT, u_palette);\n}\n\n// Sierpinski Triangle test using base-2 fractional folding\n// Returns t in [0,1], where lower values indicate earlier removal (more hollow)\nfloat sierpinskiTri(vec2 pNorm) {\n  vec2 q = pNorm;\n  float tLevel = 1.0;\n  for (int ii = 0; ii < 1024; ii++) {\n    if (ii >= u_maxIter) break;\n    vec2 r = fract(q * 2.0);\n    // In a unit triangle tiling, points with r.x + r.y > 1 are in the 'removed' central region\n    if (r.x + r.y > 1.0) {\n      tLevel = float(ii) / max(1.0, float(u_maxIter));\n      return tLevel; // early removal\n    }\n    q = r;\n  }\n  return 1.0; // never removed => deepest level\n}\n\n// Sierpinski Carpet using base-3 digit test\nfloat sierpinskiCarpet(vec2 pNorm) {\n  vec2 q = pNorm;\n  float tLevel = 1.0;\n  for (int ii = 0; ii < 1024; ii++) {\n    if (ii >= u_maxIter) break;\n    vec2 r = fract(q * 3.0);\n    if (r.x > 1.0/3.0 && r.x < 2.0/3.0 && r.y > 1.0/3.0 && r.y < 2.0/3.0) {\n      tLevel = float(ii) / max(1.0, float(u_maxIter));\n      return tLevel;\n    }\n    q = r;\n  }\n  return 1.0;\n}\n\nfloat isMiddleThird(float a) {\n  return step(1.0/3.0, a) * step(a, 2.0/3.0);\n}\n\n// Menger Sponge membership depth using base-3 rule: removed if at any level, at least two axes in middle third\nfloat mengerDepth(vec3 p) {\n  vec3 q = p;\n  for (int ii = 0; ii < 128; ii++) {\n    if (ii >= u_maxIter) break;\n    vec3 r = fract(q * 3.0);\n    float midCount = isMiddleThird(r.x) + isMiddleThird(r.y) + isMiddleThird(r.z);\n    if (midCount >= 2.0) {\n      return float(ii) / max(1.0, float(u_maxIter));\n    }\n    q = r;\n  }\n  return 1.0;\n}\n\n// Sierpinski Pyramid (tetrahedral gasket) approximate rule: removed when x+y+y >1 in tri, generalized to 3D as sum > 1\nfloat sierpinskiPyramidDepth(vec3 p) {\n  vec3 q = p;\n  for (int ii = 0; ii < 128; ii++) {\n    if (ii >= u_maxIter) break;\n    vec3 r = fract(q * 2.0);\n    if (r.x + r.y + r.z > 1.0) {\n      return float(ii) / max(1.0, float(u_maxIter));\n    }\n    q = r;\n  }\n  return 1.0;\n}\n\n// Plasma effect\nvec3 colorPlasma(vec2 p) {\n    float t = u_time * 0.5;\n    float v = 0.0;\n    v += sin(p.x * 8.0 + t);\n    v += sin((p.y * 5.0 - t) * 2.0);\n    v += sin((p.x + p.y + t) * 4.0);\n    vec2 p2 = p * 2.0;\n    v += sin(sqrt(p2.x*p2.x + p2.y*p2.y + 1.0) + t);\n    v = v / 4.0;\n    return getPalette(v, u_palette);\n}\n\n// Dynamic Morph\nvec3 colorDynamicMorph(vec3 p) {\n  vec3 q = p;\n  float t = u_time * 0.1;\n  for (int i = 0; i < 10; i++) {\n    if (i >= u_maxIter) break;\n    q = abs(q) / dot(q, q) - vec3(0.5 + 0.3*sin(t), 0.5 + 0.3*cos(t), 0.5 + 0.3*sin(t*1.2));\n  }\n  return getPalette(length(q), u_palette);\n}\n\nvoid main() {\n  // Map pixel to complex plane, keeping aspect ratio\n  vec2 uv = (gl_FragCoord.xy / u_resolution) * 2.0 - 1.0; // [-1,1]\n  float aspect = u_resolution.x / max(1.0, u_resolution.y);\n  uv.x *= aspect;\n\n  // span defines width of plane; scale uv accordingly and rotate\n  vec2 z = (rot(u_rotation) * uv) * (u_span * 0.5) + u_center;\n\n  vec3 col;\n  if (u_fractalType == 0) {\n    col = colorJulia(z);\n  } else if (u_fractalType == 1) {\n    // Map to unit square roughly centered around current center/span\n    vec2 pNorm = z / max(1e-6, u_span) + vec2(0.5);\n    float tTri = sierpinskiTri(pNorm);\n    float shade = 1.0 - tTri; // earlier removal = brighter\n    col = getPalette(shade, u_palette);\n  } else if (u_fractalType == 2) {\n    vec2 pNorm = z / max(1e-6, u_span) + vec2(0.5);\n    float tCar = sierpinskiCarpet(pNorm);\n    float shade = 1.0 - tCar;\n    col = getPalette(shade, u_palette);\n  } else if (u_fractalType == 3) {\n    // 3D: Menger Sponge slice; z varies over time to reveal layers\n    vec2 pNorm2 = z / max(1e-6, u_span) + vec2(0.5);\n    float zSlice = 0.5 + 0.45 * sin(u_time * 0.25);\n    vec3 p3 = vec3(pNorm2, zSlice);\n    float t = mengerDepth(p3);\n    float shade = 1.0 - t;\n    col = getPalette(shade, u_palette);\n  } else if (u_fractalType == 4) {\n    // 3D: Sierpinski Pyramid slice\n    vec2 pNorm2 = z / max(1e-6, u_span) + vec2(0.5);\n    float zSlice = 0.5 + 0.45 * sin(u_time * 0.22 + 1.0);\n    vec3 p3 = vec3(pNorm2, zSlice);\n    float t = sierpinskiPyramidDepth(p3);\n    float shade = 1.0 - t;\n    col = getPalette(shade, u_palette);\n  } else if (u_fractalType == 10) {\n    col = colorPlasma(z);\n  } else if (u_fractalType == 11) {\n    vec2 pNorm2 = z / max(1e-6, u_span) + vec2(0.5);\n    float zSlice = 0.5 + 0.45 * sin(u_time * 0.22 + 1.0);\n    vec3 p3 = vec3(pNorm2, zSlice);\n    col = colorDynamicMorph(p3);\n  } else {\n    // Overlay-only types: neutral background\n    col = vec3(0.0);\n  }\n\n  // Vignette for aesthetics\n  float d = length(uv);\n  float vig = smoothstep(1.2, 0.2, d);\n  col *= mix(0.85, 1.0, vig);\n\n  gl_FragColor = vec4(col, 1.0);\n}"),c.useProgram(l);const e=new Float32Array([-1,-1,1,-1,-1,1,1,-1,1,1,-1,1]);s=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,s),c.bufferData(c.ARRAY_BUFFER,e,c.STATIC_DRAW),u.a_position=0,c.enableVertexAttribArray(u.a_position),c.vertexAttribPointer(u.a_position,2,c.FLOAT,!1,0,0),p.u_resolution=c.getUniformLocation(l,"u_resolution"),p.u_center=c.getUniformLocation(l,"u_center"),p.u_span=c.getUniformLocation(l,"u_span"),p.u_rotation=c.getUniformLocation(l,"u_rotation"),p.u_time=c.getUniformLocation(l,"u_time"),p.u_maxIter=c.getUniformLocation(l,"u_maxIter"),p.u_palette=c.getUniformLocation(l,"u_palette"),p.u_fractalType=c.getUniformLocation(l,"u_fractalType"),c.disable(c.DEPTH_TEST),c.disable(c.CULL_FACE),c.clearColor(0,0,0,1)}function I(){const e=t.getBoundingClientRect(),a=Math.min(window.devicePixelRatio||1,2);a!==f&&(f=a);const r=Math.max(1,Math.floor(e.width*f)),i=Math.max(1,Math.floor(e.height*f));t.width===r&&t.height===i||(t.width=r,t.height=i,c.viewport(0,0,r,i),d=!0,n&&(n.width=r,n.height=i,x=!0))}function S(){i.iterationsValue.textContent=String(o.maxIter),i.zoomValue.textContent=o.scale.toFixed(2)+"×",i.rotationValue.textContent=Math.round(o.rotationDeg)+"°",i.speedValue.textContent=o.speed.toFixed(2)+"×"}function w(){a&&n&&a.clearRect(0,0,n.width,n.height)}function T(e){const t=Math.cos(e),n=Math.sin(e);return[t,-n,n,t]}function P(e,t){return{x:e[0]*t.x+e[1]*t.y,y:e[2]*t.x+e[3]*t.y}}function F(e,n){let a=(2*e-1)*(t.width/Math.max(1,t.height)),r=2*n-1;const i=P(T(o.rotationDeg*Math.PI/180),{x:a,y:r}),c=3*o.scale;return{x:i.x*(.5*c)+o.center.x,y:i.y*(.5*c)+o.center.y}}function z(e,n){const a=3*o.scale,r=P(T(-o.rotationDeg*Math.PI/180),{x:(e-o.center.x)/(.5*a),y:(n-o.center.y)/(.5*a)}),i=t.width/Math.max(1,t.height),c=r.x/Math.max(1e-6,i),l=r.y;return{x:.5*(c+1)*t.width,y:.5*(l+1)*t.height}}function E(e,t){const n=F(e,t),r=z(n.x,n.y);a.moveTo(r.x,r.y)}function k(e,t){const n=F(e,t),r=z(n.x,n.y);a.lineTo(r.x,r.y)}function D(){a&&n&&(w(),5===o.fractalType?function(e){if(!a)return;e=Math.max(0,Math.min(6,0|e));let t="F";for(let n=0;n<e;n++){let e="";for(const n of t)e+="F"===n?"F+F--F+F":n;t=e}const n=Math.PI/3;let r=.1,i=.5,o=0;const c=.8/Math.pow(3,e);a.save(),a.lineWidth=Math.max(1,Math.floor(2*f)),a.strokeStyle="#eaeaea",a.beginPath(),E(r,i);for(const e of t)"F"===e?(r+=Math.cos(o)*c,i+=Math.sin(o)*c,k(r,i)):"+"===e?o+=n:"-"===e&&(o-=n);a.stroke(),a.restore()}(o.maxIter):6===o.fractalType?function(e){if(!a)return;const t=function(e){let t="L";for(let n=0;n<e;n++){let e="";for(const n of t)e+="L"===n?"LFRFL-F-RFLFR+F+LFRFL":"R"===n?"RFLFR+F+LFRFL-F-RFLFR":n;t=e}return t}((e=Math.max(1,Math.min(5,0|e)))-1),n=Math.PI/2,r=.8/Math.pow(3,e-1);let i=.1,o=.1,c=0;a.save(),a.lineWidth=Math.max(1,Math.floor(2*f)),a.strokeStyle="#eaeaea",a.beginPath(),E(i,o);for(const e of t)"F"===e?(i+=Math.cos(c)*r,o+=Math.sin(c)*r,k(i,o)):"+"===e?c+=n:"-"===e&&(c-=n);a.stroke(),a.restore()}(o.maxIter):7===o.fractalType?function(e){if(!a)return;const t=Math.max(1,Math.min(10,0|e));a.save(),a.lineWidth=Math.max(1,Math.floor(1.2*f)),a.strokeStyle="#eaeaea",a.fillStyle="rgba(255,255,255,0.08)",function e(t,n,r,i){const o=function(e,t,n){const r=Math.cos(n)*(t/2),i=Math.sin(n)*(t/2),o=-Math.sin(n)*(t/2),c=Math.cos(n)*(t/2),l={x:e.x-r-o,y:e.y-i-c},s={x:e.x+r-o,y:e.y+i-c},u={x:e.x+r+o,y:e.y+i+c},p={x:e.x-r+o,y:e.y-i+c},f=z(F(l.x,l.y).x,F(l.x,l.y).y),m=z(F(s.x,s.y).x,F(s.x,s.y).y),h=z(F(u.x,u.y).x,F(u.x,u.y).y),d=z(F(p.x,p.y).x,F(p.x,p.y).y);return a.beginPath(),a.moveTo(f.x,f.y),a.lineTo(m.x,m.y),a.lineTo(h.x,h.y),a.lineTo(d.x,d.y),a.closePath(),a.fill(),a.stroke(),{p1:l,p2:s,p3:u,p4:p}}(t,n,r);if(i<=0)return;const c=n/Math.SQRT2,l=r-Math.PI/4,s=r+Math.PI/4,u=Math.cos(l)*(c/2),p=Math.sin(l)*(c/2),f=-Math.sin(l)*(c/2),m=Math.cos(l)*(c/2),h=Math.cos(s)*(c/2),d=Math.sin(s)*(c/2),x=-Math.sin(s)*(c/2),v=Math.cos(s)*(c/2),y={x:o.p4.x+u-f,y:o.p4.y+p-m},g={x:o.p3.x-h-x,y:o.p3.y-d-v};e(y,c,l,i-1),e(g,c,s,i-1)}({x:.5,y:.19},.18,0,t-1),a.restore()}(o.maxIter):8===o.fractalType?function(e){if(!a)return;e=Math.max(1,Math.min(12,0|e));const t=[],n={X:"F-[[X]+X]+F[+FX]-X",F:"FF"};let r="X";const i=Math.min(5,e);for(let e=0;e<i;e++){let e="";for(const t of r)e+=n[t]||t;r=e}let o=.5,c=.95,l=-Math.PI/2;const s=.02*Math.max(1,e-2);a.save(),a.lineWidth=Math.max(1,Math.floor(1.5*f)),a.strokeStyle="#eaeaea",a.beginPath(),E(o,c);for(const e of r)if("F"===e){const e=o+Math.cos(l)*s,t=c+Math.sin(l)*s;k(e,t),o=e,c=t}else if("+"===e)l+=Math.PI/7;else if("-"===e)l-=Math.PI/7;else if("["===e)t.push({x:o,y:c,dir:l});else if("]"===e){const e=t.pop();if(!e)continue;o=e.x,c=e.y,l=e.dir,a.moveTo(z(F(o,c).x,F(o,c).y).x,z(F(o,c).x,F(o,c).y).y)}a.stroke(),a.restore()}(o.maxIter):9===o.fractalType&&function(e){if(!a)return;const t=Math.max(2e3,Math.min(4e4,200*(0|e))),n=4.8378,r=9.9983,i=n/r*.9,o=.5-.5*i,c=Math.max(1,Math.floor(1*f));a.save(),a.fillStyle="rgba(234,234,234,0.9)",v.ready||(v.x=0,v.y=0,v.ready=!0);let l=v.x,s=v.y;for(let e=0;e<t;e++){const e=Math.random();let t,u;e<.01?(t=0,u=.16*s):e<.86?(t=.85*l+.04*s,u=-.04*l+.85*s+1.6):e<.93?(t=.2*l-.26*s,u=.23*l+.22*s+1.6):(t=-.15*l+.28*s,u=.26*l+.24*s+.44),l=t,s=u;const p=F(o+(l- -2.182)/n*i,.05+(s-0)/r*.9),f=z(p.x,p.y);a.fillRect(f.x,f.y,c,c)}v.x=l,v.y=s,a.restore()}(o.maxIter))}function R(){c&&(I(),c.clear(c.COLOR_BUFFER_BIT),c.uniform2f(p.u_resolution,t.width,t.height),c.uniform2f(p.u_center,o.center.x,o.center.y),c.uniform1f(p.u_span,3*o.scale),c.uniform1f(p.u_rotation,o.rotationDeg*Math.PI/180),c.uniform1f(p.u_time,h*o.speed),c.uniform1i(p.u_maxIter,0|o.maxIter),c.uniform1i(p.u_palette,0|o.palette),c.uniform1i(p.u_fractalType,0|o.fractalType),c.drawArrays(c.TRIANGLES,0,6),o.fractalType>=5?D():a&&w())}let C=0;function A(e){const t=(e-m)/1e3;m=e,o.playing&&(h+=t,d=!0),d&&(R(),d=!1),C=requestAnimationFrame(A)}function q(){cancelAnimationFrame(C),m=performance.now(),C=requestAnimationFrame(A)}let U=!1,N={x:0,y:0},V={active:!1,d0:0,scale0:1};function X(e,t){U=!0,N.x=e,N.y=t}function B(e,n){if(!U||V.active)return;const a=e-N.x,r=n-N.y;N.x=e,N.y=n;const i=function(e,n){const a=3*o.scale,r=t.width/Math.max(1,t.height),i=e/t.width*a*r,c=-n/t.height*a,l=o.rotationDeg*Math.PI/180,s=Math.cos(l),u=Math.sin(l);return{x:s*i-u*c,y:u*i+s*c}}(a,r);o.center.x-=i.x,o.center.y-=i.y,d=!0}function O(){U=!1}function Y(e,t){const n=e.clientX-t.clientX,a=e.clientY-t.clientY;return Math.hypot(n,a)}function G(){try{!function(){const e={antialias:!1,preserveDrawingBuffer:!1,alpha:!1,powerPreference:"high-performance"};if(c=t.getContext("webgl",e)||t.getContext("experimental-webgl",e),!c)throw new Error("WebGL not supported");t.addEventListener("webglcontextlost",e=>{e.preventDefault(),cancelAnimationFrame(C)}),t.addEventListener("webglcontextrestored",()=>{b(),d=!0,q()})}(),b()}catch(t){return console.error(t),e="WebGL failed to initialize: "+t.message,void(r&&(r.classList.remove("hidden"),r.textContent=e||r.textContent))}var e;i.fractal&&(i.fractal.value=String(o.fractalType)),i.palette.value=String(o.palette),i.iterations.value=String(o.maxIter),i.zoom.value=String(o.scale),i.rotation.value=String(o.rotationDeg),i.speed.value=String(o.speed),S(),function(){function e(){const e=!!y.src;i.musicPlay&&(i.musicPlay.disabled=!e,i.musicPlay.setAttribute("aria-pressed",String(e&&!y.paused))),i.musicStop&&(i.musicStop.disabled=!e,i.musicStop.setAttribute("aria-pressed","false"))}i.fractal&&i.fractal.addEventListener("input",e=>{const t=0|parseInt(e.target.value,10);var n;t!==o.fractalType&&(o.fractalType=t,0===(n=t)?(o.maxIter=200,o.scale=1,o.rotationDeg=0,o.center={x:-.2,y:0}):1===n?(o.maxIter=9,o.scale=1.2,o.rotationDeg=0,o.center={x:0,y:0}):2===n?(o.maxIter=6,o.scale=1,o.rotationDeg=0,o.center={x:0,y:0}):3===n?(o.maxIter=5,o.scale=1,o.rotationDeg=0,o.center={x:0,y:0}):4===n?(o.maxIter=9,o.scale=1,o.rotationDeg=0,o.center={x:0,y:0}):5===n?(o.maxIter=4,o.scale=1,o.rotationDeg=0,o.center={x:0,y:0}):6===n?(o.maxIter=5,o.scale=1,o.rotationDeg=0,o.center={x:0,y:0}):7===n?(o.maxIter=9,o.scale=1,o.rotationDeg=0,o.center={x:0,y:0}):8===n?(o.maxIter=6,o.scale=1,o.rotationDeg=0,o.center={x:0,y:0}):9===n?(o.maxIter=200,o.scale=1,o.rotationDeg=0,o.center={x:0,y:0},v.ready=!1):10===n?(o.maxIter=50,o.scale=1,o.rotationDeg=0,o.center={x:0,y:0}):11===n&&(o.maxIter=10,o.scale=1,o.rotationDeg=0,o.center={x:0,y:0}),i.iterations.value=String(o.maxIter),i.zoom.value=String(o.scale),i.rotation.value=String(o.rotationDeg),S(),v.ready=!1,d=!0)}),i.palette.addEventListener("input",e=>{o.palette=parseInt(e.target.value,10),d=!0,S()}),i.iterations.addEventListener("input",e=>{o.maxIter=parseInt(e.target.value,10),d=!0,S()}),i.zoom.addEventListener("input",e=>{o.scale=parseFloat(e.target.value),d=!0,S()}),i.rotation.addEventListener("input",e=>{o.rotationDeg=parseFloat(e.target.value),d=!0,S()}),i.speed.addEventListener("input",e=>{o.speed=parseFloat(e.target.value),d=!0,S()}),i.playPause.addEventListener("click",()=>{o.playing=!o.playing,i.playPause.textContent=o.playing?"Pause":"Play",i.playPause.setAttribute("aria-pressed",String(o.playing)),d=!0}),i.reset.addEventListener("click",()=>{Object.assign(o,{fractalType:0,palette:0,maxIter:200,scale:1,rotationDeg:0,speed:1,playing:!0,center:{x:-.2,y:0}}),i.fractal&&(i.fractal.value=String(o.fractalType)),i.palette.value=String(o.palette),i.iterations.value=String(o.maxIter),i.zoom.value=String(o.scale),i.rotation.value=String(o.rotationDeg),i.speed.value=String(o.speed),i.playPause.textContent="Pause",i.playPause.setAttribute("aria-pressed","true"),v.ready=!1,d=!0,S()}),i.recenter&&i.recenter.addEventListener("click",()=>{const e=0===o.fractalType?{x:-.2,y:0}:{x:0,y:0};o.center={x:e.x,y:e.y},d=!0}),i.musicFile&&i.musicFile.addEventListener("change",()=>{const t=i.musicFile.files&&i.musicFile.files[0];if(t){try{y.pause()}catch(e){}if(y.currentTime=0,g){try{URL.revokeObjectURL(g)}catch(e){}g=null}g=URL.createObjectURL(t),y.src=g,e()}}),i.musicPlay&&i.musicPlay.addEventListener("click",()=>{if(!y.src)return;const t=y.play();t&&"function"==typeof t.then?t.then(()=>e()).catch(t=>{console.warn("Music play failed:",t),e()}):e()}),i.musicStop&&i.musicStop.addEventListener("click",()=>{if(y.src){try{y.pause()}catch(e){}try{y.currentTime=0}catch(e){}e()}}),y.addEventListener("play",e),y.addEventListener("pause",e)}(),_(function(){try{return"1"===localStorage.getItem(M)}catch(e){return!1}}()),t.style.width="100%",t.style.height="100%",I(),R(),q()}t.addEventListener("touchstart",e=>{1===e.touches.length?X(e.touches[0].clientX,e.touches[0].clientY):2===e.touches.length&&(V.active=!0,V.d0=Y(e.touches[0],e.touches[1]),V.scale0=o.scale)},{passive:!1}),t.addEventListener("touchmove",e=>{if(e.preventDefault(),1!==e.touches.length||V.active){if(2===e.touches.length){const t=Y(e.touches[0],e.touches[1]),n=V.d0/Math.max(1,t);o.scale=Math.min(10,Math.max(.1,V.scale0*n)),i.zoom.value=String(o.scale),S(),d=!0}}else B(e.touches[0].clientX,e.touches[0].clientY)},{passive:!1}),t.addEventListener("touchend",()=>{V.active=!1,O()}),t.addEventListener("mousedown",e=>X(e.clientX,e.clientY)),window.addEventListener("mousemove",e=>B(e.clientX,e.clientY)),window.addEventListener("mouseup",O),t.addEventListener("wheel",function(e){e.preventDefault();const n=Math.exp(.001*-e.deltaY),a=t.getBoundingClientRect(),r=(e.clientX-a.left)*f,c=(e.clientY-a.top)*f,l=t.width/Math.max(1,t.height),s=(r/t.width*2-1)*l,u=c/t.height*2-1,p=o.rotationDeg*Math.PI/180,m=Math.cos(p)*s-Math.sin(p)*u,h=Math.sin(p)*s+Math.cos(p)*u,x=3*o.scale,v=m*(.5*x)+o.center.x,y=h*(.5*x)+o.center.y;o.scale=Math.min(10,Math.max(.1,o.scale/n)),i.zoom.value=String(o.scale);const g=3*o.scale,M=m*(.5*g)+o.center.x,_=h*(.5*g)+o.center.y;o.center.x+=v-M,o.center.y+=y-_,S(),d=!0},{passive:!1}),t.addEventListener("dblclick",function(e){e.preventDefault(),_(!(i.controls&&i.controls.classList.contains("hidden")))}),window.addEventListener("resize",()=>{d=!0}),document.addEventListener("keydown",e=>{if(e.defaultPrevented)return;if(e.ctrlKey||e.metaKey||e.altKey)return;const t=document.activeElement,n=t&&t.tagName?t.tagName.toUpperCase():"";"INPUT"===n||"SELECT"===n||"TEXTAREA"===n||t&&t.isContentEditable||"h"!==e.key&&"H"!==e.key||_(!(i.controls&&i.controls.classList.contains("hidden")))}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",G):G()})();